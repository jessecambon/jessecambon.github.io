I"‰^<p>Tidy evaluation is a framework for controlling how expressions and variables in your code are evaluated by <a href="https://www.tidyverse.org/">tidyverse</a> functions. This framework, housed in the <a href="https://rlang.r-lib.org">rlang package</a>, is a powerful tool for writing more efficient and elegant code. In particular, youâ€™ll find it useful for passing variable names as inputs to functions that use tidyverse packages like <a href="https://dplyr.tidyverse.org/">dplyr</a> and <a href="https://ggplot2.tidyverse.org/">ggplot2</a>.</p>

<p>The goal of this post is to offer accessible examples and intuition for putting tidy evaluation to work in your own code. Because of this I will keep conceptual explanations brief, but for more comprehensive documentation you can refer to <a href="https://dplyr.tidyverse.org/reference/tidyeval.html">dplyrâ€™s website</a>, <a href="https://rlang.r-lib.org/">rlangâ€™s website</a>, the <a href="https://tidyeval.tidyverse.org/">â€˜Tidy Evaluationâ€™ book</a> by Lionel Henry and Hadley Wickham, and the <a href="https://adv-r.hadley.nz/metaprogramming.html">Metaprogramming Section of the â€˜Advanced Râ€™ book</a> by Hadley Wickham.</p>

<h3 id="motivating-example">Motivating Example</h3>

<p>To begin, letâ€™s consider a simple example of calculating summary statistics with the <a href="https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/mtcars.html">mtcars dataset</a>. Below we calculate maximum and minimum horsepower (hp) by the number of cylinders (cyl) using the <a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a> and <a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a> functions from <a href="https://dplyr.tidyverse.org/">dplyr</a>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">
</span><span class="n">hp_by_cyl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mtcars</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">cyl</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarize</span><span class="p">(</span><span class="n">min_hp</span><span class="o">=</span><span class="nf">min</span><span class="p">(</span><span class="n">hp</span><span class="p">),</span><span class="w">
            </span><span class="n">max_hp</span><span class="o">=</span><span class="nf">max</span><span class="p">(</span><span class="n">hp</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: right">cyl</th>
      <th style="text-align: right">min_hp</th>
      <th style="text-align: right">max_hp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">4</td>
      <td style="text-align: right">52</td>
      <td style="text-align: right">113</td>
    </tr>
    <tr>
      <td style="text-align: right">6</td>
      <td style="text-align: right">105</td>
      <td style="text-align: right">175</td>
    </tr>
    <tr>
      <td style="text-align: right">8</td>
      <td style="text-align: right">150</td>
      <td style="text-align: right">335</td>
    </tr>
  </tbody>
</table>

<p>Now letâ€™s say we wanted to repeat this calculation multiple times <em>while changing which variable we group by</em>. A brute force method to accomplish this would be to copy and paste our code as many times as necessary and modify the group by variable in each iteration. However, this is inefficient especially if our code gets more complicated, requires many iterations, or requires further development.</p>

<p>To avoid this inelegant solution you might think to store the name of a variable inside of another variable like this <code class="highlighter-rouge">groupby_var &lt;- "vs"</code>. Then you could attempt to use your newly created â€œgroupby_varâ€ variable in your code: <code class="highlighter-rouge">group_by(groupby_var)</code>. However, if you try this you will find it doesnâ€™t work. The â€œgroup_byâ€ function expects the name of the variable you want to group by as an input, not the name of a variable that <em>contains</em> the name of the variable you want to group by.</p>

<p>This is the kind of headache that tidy evaluation can help you solve. In the example below we use the <a href="https://rlang.r-lib.org/reference/quotation.html">quo</a> function and the â€œbang-bangâ€ <a href="https://rlang.r-lib.org/reference/nse-force.html">!!</a> operator to set â€œvsâ€ (engine type, 0 = automatic, 1 = manual) as our group by variable. The â€œquoâ€ function allows us to store the variable name in our â€œgroupby_varâ€ variable and â€œ!!â€ extracts the stored variable name.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">groupby_var</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">quo</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span><span class="w">

</span><span class="n">hp_by_vs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mtcars</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">group_by</span><span class="p">(</span><span class="o">!!</span><span class="n">groupby_var</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarize</span><span class="p">(</span><span class="n">min_hp</span><span class="o">=</span><span class="nf">min</span><span class="p">(</span><span class="n">hp</span><span class="p">),</span><span class="w">
            </span><span class="n">max_hp</span><span class="o">=</span><span class="nf">max</span><span class="p">(</span><span class="n">hp</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: right">vs</th>
      <th style="text-align: right">min_hp</th>
      <th style="text-align: right">max_hp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">0</td>
      <td style="text-align: right">91</td>
      <td style="text-align: right">335</td>
    </tr>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: right">52</td>
      <td style="text-align: right">123</td>
    </tr>
  </tbody>
</table>

<p>The code above provides a method for setting the group by variable by modifying the input to the â€œquoâ€ function when we define â€œgroupby_varâ€. This can be useful, particularly if we intend to reference the group by variable multiple times. However, if we want to use code like this repeatedly in a script then we should consider packaging it into a function. This is what we will do next.</p>

<h3 id="making-functions-with-tidy-evaluation">Making Functions with Tidy Evaluation</h3>

<p>To use tidy evaluation in a function, we will still use the â€œ!!â€ operator as we did above, but instead of â€œquoâ€ we will use the <a href="https://rlang.r-lib.org/reference/nse-defuse.html">enquo</a> function. Our new function below takes the group by variable and the measurement variable as inputs so that we can now calculate maximum and minimum values of any variable we want. Also note two new features I have introduced in this function:</p>

<ul>
  <li>The <a href="https://rlang.r-lib.org/reference/as_label.html">as_label</a> function extracts the string value of the â€œmeasure_varâ€ variable (â€œhpâ€ in this case). We use this to set the value of the â€œmeasure_varâ€ column.</li>
  <li>The â€œwalrus operatorâ€ <a href="https://rlang.r-lib.org/reference/quasiquotation.html#forcing-names">:=</a> is used to create a column named after the variable name stored in the â€œmeasure_varâ€ argument (â€œhpâ€ in the example). The walrus operator allows you to use strings and evaluated variables (such as â€œmeasure_varâ€ in our example) on the left hand side of an assignment operation (where there would normally be a â€œ=â€ operator) in functions such as â€œmutateâ€ and â€œsummarizeâ€.</li>
</ul>

<p>Below we define our function and use it to group by â€œamâ€ (transmission type, 0 = automatic, 1 = manual) and calculate summary statistics with the â€œhpâ€ (horsepower) variable.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">car_stats</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">groupby_var</span><span class="p">,</span><span class="n">measure_var</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">groupby_var</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enquo</span><span class="p">(</span><span class="n">groupby_var</span><span class="p">)</span><span class="w">
  </span><span class="n">measure_var</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enquo</span><span class="p">(</span><span class="n">measure_var</span><span class="p">)</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">mtcars</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">group_by</span><span class="p">(</span><span class="o">!!</span><span class="n">groupby_var</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">summarize</span><span class="p">(</span><span class="n">min</span><span class="o">=</span><span class="nf">min</span><span class="p">(</span><span class="o">!!</span><span class="n">measure_var</span><span class="p">),</span><span class="w">
              </span><span class="n">max</span><span class="o">=</span><span class="nf">max</span><span class="p">(</span><span class="o">!!</span><span class="n">measure_var</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="n">mutate</span><span class="p">(</span><span class="n">measure_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as_label</span><span class="p">(</span><span class="n">measure_var</span><span class="p">),</span><span class="w">
            </span><span class="o">!!</span><span class="n">measure_var</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">NA</span><span class="p">)</span><span class="w">
    </span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">hp_by_am</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">car_stats</span><span class="p">(</span><span class="n">am</span><span class="p">,</span><span class="n">hp</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: right">am</th>
      <th style="text-align: right">min</th>
      <th style="text-align: right">max</th>
      <th style="text-align: left">measure_var</th>
      <th style="text-align: left">hp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">0</td>
      <td style="text-align: right">62</td>
      <td style="text-align: right">245</td>
      <td style="text-align: left">hp</td>
      <td style="text-align: left">NA</td>
    </tr>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: right">52</td>
      <td style="text-align: right">335</td>
      <td style="text-align: left">hp</td>
      <td style="text-align: left">NA</td>
    </tr>
  </tbody>
</table>

<p>We now have a flexible function that contains a dplyr workflow. You can experiment with modifying this function for your own purposes. Additionally, as you might suspect, you could use the same tidy evaluation functions we just used with tidyverse packages other than dplyr.</p>

<p>As an example, below Iâ€™ve defined a function that builds a scatter plot with <a href="https://ggplot2.tidyverse.org/">ggplot2</a>. The function takes a dataset and two variable names as inputs. You will notice that the dataset argument â€œdfâ€ needs no tidy evaluation. The <a href="https://rlang.r-lib.org/reference/as_label.html">as_label</a> function is used to extract our variable names as strings to create a plot title with the â€œggtitleâ€ function.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">scatter_plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">x_var</span><span class="p">,</span><span class="n">y_var</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">x_var</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enquo</span><span class="p">(</span><span class="n">x_var</span><span class="p">)</span><span class="w">
  </span><span class="n">y_var</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enquo</span><span class="p">(</span><span class="n">y_var</span><span class="p">)</span><span class="w">
  
  </span><span class="nf">return</span><span class="p">(</span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=!!</span><span class="n">x_var</span><span class="p">,</span><span class="n">y</span><span class="o">=!!</span><span class="n">y_var</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_bw</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">lineheight</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">,</span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_smooth</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="n">str_c</span><span class="p">(</span><span class="n">as_label</span><span class="p">(</span><span class="n">y_var</span><span class="p">),</span><span class="w"> </span><span class="s2">" vs. "</span><span class="p">,</span><span class="n">as_label</span><span class="p">(</span><span class="n">x_var</span><span class="p">)))</span><span class="w">
  </span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">scatter_plot</span><span class="p">(</span><span class="n">mtcars</span><span class="p">,</span><span class="n">disp</span><span class="p">,</span><span class="n">hp</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/rmd_images/2019-12-8-practical-tidy-evaluation/unnamed-chunk-7-1.png" alt="" /><!-- --></p>

<p>As you can see, weâ€™ve plotted the â€œhpâ€ (horsepower) variable against â€œdispâ€ (displacement) and added a regression line. Now, instead of copying and pasting ggplot code to create the same plot with different datasets and variables, we can just call our function.</p>

<h3 id="the-curly-curly-shortcut-and-passing-multiple-variables">The â€œCurly-Curlyâ€ Shortcut and Passing Multiple Variables</h3>

<p>To wrap things up, Iâ€™ll cover a few additional tricks and shortcuts for your tidy evaluation toolbox.</p>

<ul>
  <li>The â€œcurly-curlyâ€ <a href="https://www.tidyverse.org/blog/2019/06/rlang-0-4-0/">{{ }}</a> operator directly extracts a stored variable name from â€œmeasure_varâ€ in the example below. In the prior example we needed both â€œenquoâ€ and â€œ!!â€ to evaluate a variable like this so the â€œcurly-curlyâ€ operator is a convenient shortcut. However, note that if you want to extract the string variable name with the â€œas_labelâ€ function, you will still need to use â€œenquoâ€ and â€œ!!â€ as we have done below with â€œmeasure_nameâ€.</li>
  <li>The <a href="https://rlang.r-lib.org/reference/sym.html">syms</a> function and the â€œ!!!â€ operator are used for passing a list of variables as a function argument. In prior examples â€œ!!â€ was used to evaluate a single group by variable; we now use â€œ!!!â€ to evaluate a list of group by variables. One quirk is that to use the â€œsymsâ€ function we will need to pass the variable names in quotes.</li>
  <li>The walrus operator â€œ:=â€ is again used to create new columns, but now the column names are defined with a combination of a variable name stored in a function argument and another string (â€œ_minâ€ and â€œ_maxâ€ below). We use the â€œenquoâ€ and â€œas_labelâ€ functions to extract the string variable name from â€œmeasure_varâ€ and store it in â€œmeasure_nameâ€ and then use the â€œstr_câ€ function from <a href="https://stringr.tidyverse.org/">stringr</a> to combine strings. You can use similar code to build your own column names from variable name inputs and strings.</li>
</ul>

<p>Our new function is defined below and is first called to group by the â€œcylâ€ variable and then called to group by the â€œamâ€ and â€œvsâ€ variables. Note that the â€œ!!!â€ operator and â€œsymsâ€ function can be used with either a list of strings or a single string.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get_stats</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">groupby_vars</span><span class="p">,</span><span class="n">measure_var</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">groupby_vars</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">syms</span><span class="p">(</span><span class="n">groupby_vars</span><span class="p">)</span><span class="w">
  </span><span class="n">measure_name</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as_label</span><span class="p">(</span><span class="n">enquo</span><span class="p">(</span><span class="n">measure_var</span><span class="p">))</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="w"> 
    </span><span class="n">data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">group_by</span><span class="p">(</span><span class="o">!!!</span><span class="n">groupby_vars</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
            </span><span class="n">summarize</span><span class="p">(</span><span class="w"> </span><span class="o">!!</span><span class="n">str_c</span><span class="p">(</span><span class="n">measure_name</span><span class="p">,</span><span class="s2">"_min"</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">min</span><span class="p">({{</span><span class="n">measure_var</span><span class="p">}}),</span><span class="w">
                       </span><span class="o">!!</span><span class="n">str_c</span><span class="p">(</span><span class="n">measure_name</span><span class="p">,</span><span class="s2">"_max"</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">max</span><span class="p">({{</span><span class="n">measure_var</span><span class="p">}}))</span><span class="w">
    </span><span class="p">)}</span><span class="w">
</span><span class="n">cyl_hp_stats</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mtcars</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">get_stats</span><span class="p">(</span><span class="s2">"cyl"</span><span class="p">,</span><span class="n">mpg</span><span class="p">)</span><span class="w">
</span><span class="n">gear_stats</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mtcars</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">get_stats</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"am"</span><span class="p">,</span><span class="s2">"vs"</span><span class="p">),</span><span class="n">gear</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: right">cyl</th>
      <th style="text-align: right">mpg_min</th>
      <th style="text-align: right">mpg_max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">4</td>
      <td style="text-align: right">21.4</td>
      <td style="text-align: right">33.9</td>
    </tr>
    <tr>
      <td style="text-align: right">6</td>
      <td style="text-align: right">17.8</td>
      <td style="text-align: right">21.4</td>
    </tr>
    <tr>
      <td style="text-align: right">8</td>
      <td style="text-align: right">10.4</td>
      <td style="text-align: right">19.2</td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th style="text-align: right">am</th>
      <th style="text-align: right">vs</th>
      <th style="text-align: right">gear_min</th>
      <th style="text-align: right">gear_max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">3</td>
      <td style="text-align: right">3</td>
    </tr>
    <tr>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">3</td>
      <td style="text-align: right">4</td>
    </tr>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">5</td>
    </tr>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">5</td>
    </tr>
  </tbody>
</table>

<p>This concludes my introduction to tidy evaluation. Hopefully this serves as a useful starting point for using these concepts in your own code.</p>
:ET