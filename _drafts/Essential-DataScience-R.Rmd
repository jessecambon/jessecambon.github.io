---
layout: post
title:  "Fundamental Data Science Workflows"
date:   2019-12-8
author: Jesse Cambon
tags: [ tidyverse, data-science]
output: 
  md_document:
    pandoc_args: ["--wrap=none"]
    variant: gfm
    preserve_yaml: TRUE
---
```{r setup, include=FALSE}
library(here)
source(here::here("rmd_config.R"))
``` 

Data scientists use R for a wide variety of projects and the code that is needed can vary widely based on the objectives of the work and the type of data. However, there are some common operations that you are likely to use repeatedly in a wide variety of data science work. This post will walkthrough a few of these "essential" data science workflows with inbuilt datasets. If you're new to R, data science, or the [tidyverse](https://www.tidyverse.org/) and you want to quickly learn some useful data science workflows then this post is written for you. I will mainly rely on the [dplyr](https://dplyr.tidyverse.org/) and [tidyr](https://tidyr.tidyverse.org/), and packages which all have excellent documentation that you can refer to for further details. 

## Basic Data Manipulation

First, we need to load the tidyverse packages:

```{r, message=FALSE, results=FALSE, warning=FALSE}
library(tidyverse)
```

Now, let's take a look at the [mpg](https://ggplot2.tidyverse.org/reference/mpg.html) dataset from the [ggplot2](https://ggplot2.tidyverse.org/index.html) package:

```{r,echo=F} 
kable(head(mpg,3))
```

We'll perform a few of the most commonly used data manipulations on this dataset using the [dplyr](https://dplyr.tidyverse.org/) package. If you're not familiar with dplyr, note that the "pipe" operator %>% is used to pass the output of a function to the following function. This allows us to perform data manipulations in sequence in a clear and readable way. The <- operator is used to assign the value of what follows it to the dataset on the left (in this example we save our results to the "mpg_subset" dataset).

In this example, we select the two rows pertaining to 2005 Nissan vehicles with 4 cylinders, create two new columns, order our columns, remove two columns, and rename a column. Here are the main functions used to accomplish this:

* [filter](https://dplyr.tidyverse.org/reference/filter.html) controls which rows we want to keep from the input dataset. In this example three conditions are applied using the "&" (AND) operator.
* [mutate](https://dplyr.tidyverse.org/reference/mutate.html) is used to create new columns.
* [str_c](https://stringr.tidyverse.org/reference/str_c.html) combines multiple strings. In this case we are combining the manufacturer and model string fields into a single field with a single space in between.
* [select](https://dplyr.tidyverse.org/reference/select.html) is used to pick which columns we want to keep. A '-' before a column indicates that we want to drop that column. The everything() function is shorthand for selecting all remaining columns and is an examle of a [select helper](https://www.rdocumentation.org/packages/dplyr/versions/0.7.3/topics/select_helpers). As you can see, this select statement sets the order of the first four columns and then includes the remaining columns while removing the manfacturer and model columns.
* [rename](https://dplyr.tidyverse.org/reference/select.html) is used to rename the 'fl' column to 'fuel_type'

```{r}
mpg_subset <- mpg %>%
  filter(cyl == 4 & year >= 2005  & manufacturer == "nissan") %>%
  mutate(ratio = hwy/cty,
         make_model = str_c(manufacturer,' ',model)) %>%
  select(make_model,year,cyl,hwy,everything(),-manufacturer,-model) %>%
  rename(fuel_type = fl)
```

```{r,echo=F} 
kable(mpg_subset)
```

## Summary Statistics

Calculating summary statistics is a common task in data science. One simple metric is the count of observations (rows) by a categorical variable. Here we find the number of rows for each value of the 'cyl' (cylinders) column:

```{r}
count_cyl <- mpg %>%
  count(cyl)
```

```{r,echo=F}
kable(count_cyl)
```

A broader variety of statistics can be calculated using the [group_by](https://dplyr.tidyverse.org/reference/group_by.html) and [summarize](https://dplyr.tidyverse.org/reference/summarise.html) functions. In this example, we create a new categorical column "class_c" (which combines 2 seaters and subcompact vehicles into a single category) using the case_when function and then calculate a variety of basic summary statistics by this column. 

The arrange function is used to order the rows in the dataset in descending order of the created 'count' variable. Note that the ungroup() function is not strictly necessary, but it is a good practice if we plan to manipulate our dataset in the future without using groups.

```{r}
mpg_stats <- mpg %>% select(class,hwy) %>%
  mutate(class_c = case_when(class %in% c("2seater","subcompact") ~ "subcompact",
                               TRUE ~ class)) %>%
  group_by(class_c) %>%
  summarize(count = n(),
            max_hwy = max(hwy),
            min_hwy = min(hwy),
            median_hwy = median(hwy),
            mean_hwy = mean(hwy)) %>%
  ungroup() %>%
  arrange(desc(count)) # sort dataset
```

Note that '2seater' is reclassified as 'subcompact'

```{r,echo=F}
kable(mpg_stats)
```

## Stacking Data

If you have datasets whose columns or rows align, you can combine them by stacking them vertically or horizontally. In this example, we will first use the [slice](https://dplyr.tidyverse.org/reference/slice.html) function to subset the "mpg" dataset by row numbers to create the "mpg1" and "mpg2" datasets:

```{r}
mpg1 <- mpg %>% slice(1:2) %>% 
  select(manufacturer,model,hwy,cty) %>%
  mutate(dataset = 1)
```

```{r,echo=F} 
kable(mpg1)
```

```{r}
mpg2 <- mpg %>% slice(44:45) %>%
  select(manufacturer,model,hwy,cty) %>%
  mutate(dataset = 2)
```

```{r,echo=F} 
kable(mpg2)
```

Since these two datsets we just created, mpg1 and mpg2, have the same columns we can stack them vertically using [bind_rows](https://dplyr.tidyverse.org/reference/bind.html):

```{r}
mpg_stack_vert <- mpg1 %>% 
  bind_rows(mpg2)
```

```{r,echo=F} 
kable(mpg_stack_vert)
```

Now let's create third subsection of the 'mpg' dataset and call it 'mpg3':

```{r}
mpg3 <- mpg %>% slice(1:2,5:6) %>%
  select(displ,year)
```

```{r,echo=F} 
kable(mpg3)
```

We can stack the 'mpg_stack_vert' and 'mpg3' datasets horizontally since their rows align. We use the the [bind_cols](https://dplyr.tidyverse.org/reference/bind.html) function to do this.

```{r}
mpg_stack_horz <- mpg_stack_vert %>%
  bind_cols(mpg3)
```

```{r,echo=F} 
kable(mpg_stack_horz)
```

## Joining Data

If you have datasets that contain a common "key" column (or a set of key columns) then you can use one of the [join functions from dplyr](https://dplyr.tidyverse.org/reference/join.html) to combine these datasets. In this example, the mpg_stack_horz and car_type datasets are joined using the left_join function and the "manufacturer" and "model" columns.

```{r}
car_type <- mpg %>% select(manufacturer,model,class) %>%
  distinct() # distinct rows only
```

```{r,echo=F}
kable(head(car_type,4))
```

```{r}
joined <- mpg_stack_horz %>%
  left_join(car_type,by = c('manufacturer','model')) %>% 
  select(-dataset,everything())
```

```{r,echo=F}
kable(head(joined,4))
```

## Converting Long to Wide Format

Let's take a look at the [us_rent_income](https://tidyr.tidyverse.org/reference/us_rent_income.html) dataset from the [tidyr](https://tidyr.tidyverse.org) package:

```{r,echo=F}
kable(head(us_rent_income,4))
```

Each row of this dataset pertains to either income or rent as we can see by looking at the value of the 'variable' column. This is an example of a 'long' data format. The 'long' format is versatile, but sometimes we may want to convert to the 'wide' data format for presentation purposes. To do this, we can use the [pivot_wider](https://tidyr.tidyverse.org/reference/pivot_wider.html) function from tidyr to put rent and income into separate columns. This function has two arguments you will need to set:

* **names_from**: column containing values that we will use for our new column names
* **values_from**: column containing the values that will populate our new columns

Additionally we use the select to drop two columns, [drop_na](https://tidyr.tidyverse.org/reference/drop_na.html) to remove rows with missing values, and mutate to create an income to rent ratio.
  
```{r}
col_ratio <- us_rent_income %>%
  select(-GEOID,-moe) %>%
  pivot_wider(names_from = variable, values_from = estimate) %>% 
  drop_na() %>%   # drop missing values
  mutate(income_rent_ratio = income / (12*rent))
```

```{r,echo=F}
kable(head(col_ratio,4))
```

## Converting Wide to Long Format

Now let's look at the 'world_bank_pop' dataset from tidyr (first 6 columns only for display purposes):

```{r,echo=F}
kable(head(world_bank_pop %>% select(1:6),3))
```

This dataset is in "wide" format since a categorical variable, in this case the year, is stored in the column names. To convert this dataset to the "long" format", which can be more conveniant for data manipulation, we use the [pivot_longer](https://tidyr.tidyverse.org/reference/pivot_longer.html) function from tidyr. This function takes three inputs:

* **cols** (1st argument): a list of the columns we want to pivot. In this example we create this list by subtracting the columns we don't want to pivot.
* **names_to** : the name of new column which has the column names as values
* **values_to** : name of new column which will contain values

We also use the mutate and as.numeric() functions to convert our new 'year' variable to numeric and then filter so that our output dataset only includes certain years using the seq function. The format for 'seq' is seq(start, stop, increment).

```{r} 
wb_pop <- world_bank_pop %>%
  pivot_longer(c(-country,-indicator), names_to = "year", values_to = "value") %>%
  mutate(year = as.numeric(year)) %>% # convert to numeric
  filter(year %in% seq(2000,2016,2))
```

```{r,echo=F} 
kable(head(wb_pop,3))
```

## Visualizations

Now that we have gone through the trouble of manipulating some datasets, we'll make a few visualizations with ggplot2. Ggplot graphs are constructed by adding together a series of ggplot functions with the "+" operator. You can refer to [ggplot's documentation](https://ggplot2.tidyverse.org/reference/) for more information, but here is a quick overview:

* The [ggplot](https://ggplot2.tidyverse.org/reference/ggplot.html) function initializes a graph.
The [aes](https://ggplot2.tidyverse.org/reference/aes.html) (aesthetic mappings) function controls which variables are used in the plot.  
* Atleast one geom (geometric object) function such as geom_histogram, geom_point, or geom_line is included which defines what the graph will look like.
* The theme of the chart can be modified using [preset themes such as theme_bw and theme_classic](https://ggplot2.tidyverse.org/reference/ggtheme.html) and further customized using the [theme function](https://ggplot2.tidyverse.org/reference/theme.html).
* In ggplot, the "color" parameter is used for setting the color of lines while the "fill" parameter controls the color of areas.
* To save a plot to a file, use the [ggsave](https://ggplot2.tidyverse.org/reference/ggsave.html) function.

### Histograms

One of the simplest

```{r histogram}
# Histogram with autobinning based on gender
ggplot(mpg,aes(hwy)) +
geom_histogram(aes(fill = cyl),binwidth = 1) +
theme_bw() +
scale_y_continuous(expand = expand_scale(mult = c(0, .05))) +
xlab('Highway mpg') + ylab('Count')
```

## Bar Charts

* use fill argument in ggplot() to set bar color based on a variable
* reorder() orders the bars in descending order (left to right) by the mean_hwy variable

```{r}
# A simple bar chart - average heights of the species
# the reorder command orders our bars in order of descending height
ggplot(data = mpg_stats,
    aes(x = reorder(class_c,-mean_hwy), y = mean_hwy)) +
geom_bar(stat = 'identity', color = 'black') +
scale_y_continuous(expand = expand_scale(mult = c(0, .1))) + # expand top margin
geom_text(aes(label = round(mean_hwy)), vjust = -0.5) +  # label bars
theme_bw() + 
xlab('') + ylab('') + # no axis labels
theme(legend.position = "none", # no legend (in case we want to use fill)
  panel.grid = element_blank()) # turn off grid
```

### Line Charts

Here we create a line graph with the SP.POP.GROW indicator from the "wb_pop" dataset we created earlier based on world bank data. SP.POP.GROW is the percent population growth and we divide its value (in the 'value' column) by 100 to convert it to a decimal percentage value.

```{r line}
ggplot(wb_pop %>% filter(country %in% c("USA","CAN","MEX") & indicator == "SP.POP.GROW"), 
       aes(x = year,y = value/100,color = country)) +
theme_classic() + 
  geom_line() + geom_point() + # lines and points
scale_x_continuous(expand = expand_scale(mult = c(.05, .05))) +
scale_y_continuous(labels = scales::percent) + 
theme(legend.title = element_blank(), # suppress legend title
      panel.grid.minor.x = element_blank(),
      legend.text = element_text(size = 10),
      legend.position = 'right') +
xlab('Year') + ylab('Population Growth')
```

### Lollipop Charts

Lollipop charts can be an attractive alternative to bar charts. We construct one here using [geom_segment](https://ggplot2.tidyverse.org/reference/geom_segment.html) and [geom_point](https://ggplot2.tidyverse.org/reference/geom_point.html). The [coord_flip](https://ggplot2.tidyverse.org/reference/coord_flip.html) function is used to orient the chart horizontally instead of vertically.

```{r lollipop}
  ggplot(data = col_ratio %>% arrange(desc(rent)) %>% head(15), aes(x = NAME, y = rent) ) +
    geom_segment( aes(x = reorder(NAME,rent) ,xend = NAME, y = 0, yend = rent), color = "grey") +
    geom_point(size = 3) +
   theme_minimal() +
  theme(plot.subtitle = element_text(face = "bold",hjust = 0.5),
      plot.title = element_text(lineheight = 1, face = "bold",hjust = 0.5),
      panel.grid.minor.y = element_blank(),
      panel.grid.major.y = element_blank(),
      panel.grid.minor.x = element_blank()
    ) +
  coord_flip() +
    scale_y_continuous(labels = scales::dollar,expand = expand_scale(mult = c(0, .1))) + 
    labs(title = 'States With Highest Rent',
        caption = 'Source: 2017 American Community Survey (Census)') +
    xlab('') + ylab('Median Monthly Rent')
```

## References

Here are a few functions and packages you may find useful for reference:

* For importing data from files, refer to the [readr](https://readr.tidyverse.org/) (for CSV and text files) or [readxl](https://readxl.tidyverse.org/) (for excel spreadsheets) packages. 
* To coerce a column into a different format, you can use the as.numeric, as.character, as.Date, and as.factor functions (from base R). For more functions to work with date and datetime data see the [lubridate](https://lubridate.tidyverse.org/reference/index.html) package, for strings use the [stringr](https://stringr.tidyverse.org/) package, and for manipulating factors see the [forcats](https://forcats.tidyverse.org/) package. 
* For quickly summarizing datasets with summary statistics, use the summary function (base R) or the [skimr](https://docs.ropensci.org/skimr/) package.